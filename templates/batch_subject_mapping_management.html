{% extends "base1.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Manage Batch-Subject Mappings</h1>
</div>

<div class="form-container mb-4">
    <h4>Add New Mapping</h4>
    <form action="{{ url_for('add_record', table_name='batch_subjects') }}" method="POST">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="batch_id_map" class="form-label">Batch <span class="text-danger">*</span></label>
                <select class="form-select" id="batch_id_map" name="batch_id" required>
                    <option value="">-- Select Batch --</option>
                    {% for batch in batches %}
                        <option value="{{ batch.batch_id }}">{{ batch.year }} (Sem {{ batch.semester }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="semester_map" class="form-label">Semester <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="semester_map" name="semester" min="1" max="8" value="1" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="subject_id" class="form-label">Subject <span class="text-danger">*</span></label>
                <select class="form-select" id="subject_id" name="subject_id" required>
                    <option value="">-- Select Subject --</option>
                    {% for subject in subjects %}
                        <option value="{{ subject.subject_id }}">{{ subject.subject_code }} - {{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Mapping</button>
    </form>
</div>
<div class="form-container mb-4">
    <h4>Add New Subject</h4>
    <form action="{{ url_for('add_record', table_name='subjects') }}" method="POST">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="subject_code" class="form-label">Subject Code <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="subject_code" name="subject_code" placeholder="e.g., CSE101" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="name" class="form-label">Subject Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="credits" class="form-label">Credits <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="credits" name="credits" value="3" min="1" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="has_lab" class="form-label">Has Lab?</label>
                <select class="form-select" id="has_lab" name="has_lab">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="term_end_exam" class="form-label">Term End Exam?</label>
                <select class="form-select" id="term_end_exam" name="term_end_exam">
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="is_internal_only" class="form-label">Internal Only?</label>
                <select class="form-select" id="is_internal_only" name="is_internal_only">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Subject</button>
    </form>
</div>

<div class="table-container">
    <h4>Existing Batch-Subject Mappings</h4>
    <div class="filters mb-3 row g-3">
        <div class="col-md-3">
            <label for="filter_academic_year_bs" class="form-label">Academic Year</label>
            <select class="form-select" id="filter_academic_year_bs">
                <option value="">-- All Academic Years --</option>
                {% for year in academic_years %}
                    <option value="{{ year.year_id }}">{{ year.year_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="filter_batch_bs" class="form-label">Batch</label>
            <select class="form-select" id="filter_batch_bs" disabled>
                <option value="">-- Select Academic Year First --</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="filter_semester_bs" class="form-label">Semester</label>
            <select class="form-select" id="filter_semester_bs">
                <option value="">-- All Semesters --</option>
                {% for i in range(1, 9) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-12 mt-3">
            <button type="button" class="btn btn-primary me-2" id="apply_filter_bs">Apply Filters</button>
            <button type="button" class="btn btn-secondary" id="clear_filter_bs">Clear Filters</button>
        </div>
    </div>
    <div class="table-responsive">
        <table id="mappingsTable" class="table table-striped table-hover compact">
            <thead>
                <tr>
                    <th>Mapping ID</th>
                    <th>Batch Year</th>
                    <th>Semester</th>
                    <th>Subject Code</th>
                    <th>Subject Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {# Mappings data will be loaded here via AJAX #}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        let mappingsDataTable; // Declare globally or in a scope accessible by refreshTableData

        // Function to refresh DataTable with filtered data
        window.refreshTableData = function() {
            // Check if window.showLoading is available
            if (typeof window.showLoading === 'function') {
                window.showLoading(true);
            }
            const academic_year_id = $('#filter_academic_year_bs').val();
            const batch_id = $('#filter_batch_bs').val();
            const semester = $('#filter_semester_bs').val();

            $.getJSON(`/api/get_batch_subject_mappings_by_filters?academic_year_id=${academic_year_id}&batch_id=${batch_id}&semester=${semester}`, function(data) {
                if (mappingsDataTable) {
                    mappingsDataTable.destroy(); // Destroy existing DataTable instance
                }
                
                let tableRowsHtml = '';
                if (data.length === 0) {
                    tableRowsHtml = '<tr><td colspan="6" class="text-center">No mappings found matching criteria.</td></tr>';
                } else {
                    $.each(data, function(key, mapping) {
                        tableRowsHtml += `
                            <tr>
                                <td>${mapping.batch_subject_id}</td>
                                <td>${mapping.batch_year}</td>
                                <td>${mapping.semester}</td>
                                <td>${mapping.subject_code}</td>
                                <td>${mapping.subject_name}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning edit-btn"
                                            data-table="batch_subjects"
                                            data-pk="batch_subject_id"
                                            data-pk-value="${mapping.batch_subject_id}">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <a href="/delete/batch_subjects/batch_subject_id/${mapping.batch_subject_id}"
                                       class="btn btn-sm btn-danger delete-btn">
                                        <i class="bi bi-trash"></i> Delete
                                    </a>
                                </td>
                            </tr>
                        `;
                    });
                }
                $('#mappingsTable tbody').html(tableRowsHtml);

                mappingsDataTable = $('#mappingsTable').DataTable({
                    "paging": true,
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "responsive": true,
                     "initComplete": function(settings, json) {
                        // Check if window.showLoading is available
                        if (typeof window.showLoading === 'function') {
                            window.showLoading(false); // Hide loading after DataTable is initialized
                        }
                    }
                });
            }).fail(function(jqXHR) {
                // Check if window.showLoading is available
                if (typeof window.showLoading === 'function') {
                    window.showLoading(false);
                }
                window.showMessageModal('Error loading batch-subject mappings: ' + (jqXHR.responseJSON?.error || jqXHR.responseText), 'error');
                if (mappingsDataTable) {
                    mappingsDataTable.clear().draw();
                }
                $('#mappingsTable tbody').html('<tr><td colspan="6" class="text-center">Error loading data.</td></tr>');
            });
        }

        // Initial load of data
        refreshTableData();

        // Filter event listeners
        $('#apply_filter_bs').click(function() {
            refreshTableData();
        });

        $('#clear_filter_bs').click(function() {
            $('#filter_academic_year_bs').val('');
            $('#filter_batch_bs').empty().append('<option value="">-- Select Academic Year First --</option>').prop('disabled', true);
            $('#filter_semester_bs').val('');
            refreshTableData();
        });

        // Dependent Dropdown for Filters: Academic Year -> Batches
        $('#filter_academic_year_bs').change(function() {
            const academic_year_id = $(this).val();
            const batchDropdown = $('#filter_batch_bs');
            batchDropdown.empty().append('<option value="">-- Loading Batches --</option>');
            batchDropdown.prop('disabled', true);

            if (academic_year_id) {
                $.getJSON('/api/get_batches_by_academic_year/' + academic_year_id, function(data) {
                    batchDropdown.empty().append('<option value="">-- All Batches --</option>');
                    if (data && data.length > 0) {
                        $.each(data, function(key, val) {
                            batchDropdown.append('<option value="' + val.batch_id + '">' + val.display_name + '</option>');
                        });
                        batchDropdown.prop('disabled', false);
                    } else {
                        batchDropdown.append('<option value="">No batches found</option>');
                    }
                }).fail(function(jqXHR) {
                    batchDropdown.empty().append('<option value="">Error loading batches</option>');
                    window.showMessageModal('Error loading batches for filter: ' + (jqXHR.responseJSON?.error || jqXHR.responseText), 'error');
                });
            } else {
                batchDropdown.empty().append('<option value="">-- Select Academic Year First --</option>');
            }
        });
    });
</script>
{% endblock %}
