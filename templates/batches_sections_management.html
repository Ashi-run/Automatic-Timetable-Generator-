{% extends "base1.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Manage Batches & Sections</h1>
</div>

<div class="form-container mb-4">
    <h4>Add New Batch</h4>
    <form id="add-batch-form" action="{{ url_for('add_record', table_name='batches') }}" method="POST">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="year" class="form-label">Batch Year (e.g., 1 for First Year) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="year" name="year" min="1" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="academic_year_id" class="form-label">Academic Year <span class="text-danger">*</span></label>
                <select class="form-select" id="academic_year_id" name="academic_year_id" required>
                    <option value="">-- Select Academic Year --</option>
                    {% for year in academic_years %}
                        <option value="{{ year.year_id }}" {% if year.is_current %}selected{% endif %}>{{ year.year_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="semester" class="form-label">Semester <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="semester" name="semester" value="1" min="1" max="8" required>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Batch</button>
    </form>
</div>

<div class="form-container mb-4">
    <h4>Add New Section to a Batch</h4>
    <form id="add-section-form" action="{{ url_for('add_record', table_name='sections') }}" method="POST">
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="batch_id_section" class="form-label">Batch <span class="text-danger">*</span></label>
                <select class="form-select" id="batch_id_section" name="batch_id" required>
                    <option value="">-- Select Batch --</option>
                    {% for batch in batches %}
                        <option value="{{ batch.batch_id }}">{{ batch.year }} (Sem {{ batch.semester }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="section_name" class="form-label">Section Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="section_name" name="name" placeholder="e.g., A, B, C" required>
            </div>
            <div class="col-md-3 mb-3">
                <label for="theory_room_id" class="form-label">Preferred Theory Room</label>
                <select class="form-select" id="theory_room_id" name="theory_room_id">
                    <option value="">-- Select Room --</option>
                    {% for room in theory_rooms %}
                    <option value="{{ room.room_id }}">{{ room.room_number }} ({{ room.room_type }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end mb-3">
                <button type="submit" class="btn btn-primary w-100">Add Section</button>
            </div>
        </div>
    </form>
</div>

<div class="table-container mb-4">
    <h4>Existing Batches</h4>
    <div class="table-responsive">
        <table id="batchesTable" class="table table-striped table-hover compact">
            <thead>
                <tr>
                    <th>Batch ID</th>
                    <th>Year</th>
                    <th>Academic Year</th>
                    <th>Semester</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for batch in batches %}
                <tr>
                    <td>{{ batch.batch_id }}</td>
                    <td>{{ batch.year }}</td>
                    <td>{{ batch.academic_year_name }}</td>
                    <td>{{ batch.semester }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn"
                                data-table="batches"
                                data-pk="batch_id"
                                data-pk-value="{{ batch.batch_id }}">
                                
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <a href="{{ url_for('delete_record', table_name='batches', primary_key='batch_id', primary_value=batch.batch_id) }}"
                           class="btn btn-sm btn-danger delete-btn">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="table-container">
    <h4>Existing Sections</h4>
    <div class="table-responsive">
        <table id="sectionsTable" class="table table-striped table-hover compact">
            <thead>
                <tr>
                    <th>Section ID</th>
                    <th>Batch (Year & Semester)</th>
                    <th>Section Name</th>
                    <th>Theory Room</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for section in sections %}
                <tr>
                    <td>{{ section.section_id }}</td>
                    <td>{{ section.batch_year }} (Sem {{ section.batch_semester }})</td>
                    <td>{{ section.name }}</td>
                    <td>{{ section.theory_room_number if section.theory_room_number else 'N/A' }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn"
                                data-table="sections"
                                data-pk="section_id"
                                data-pk-value="{{ section.section_id }}">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <a href="{{ url_for('delete_record', table_name='sections', primary_key='section_id', primary_value=section.section_id) }}"
                           class="btn btn-sm btn-danger delete-btn">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('#batchesTable').DataTable({
            "paging": true, "searching": true, "ordering": true, "info": true, "responsive": true
        });
        $('#sectionsTable').DataTable({
            "paging": true, "searching": true, "ordering": true, "info": true, "responsive": true
        });

        window.refreshTableData = function() {
            window.location.reload();
        };

        // Edit Modal for Batches
        $(document).on('click', '.edit-btn[data-table="batches"]', function() {
            const batchId = $(this).data('pk-value');
            $.ajax({
                url: `/get_row/batches?primary_key=batch_id&primary_value=${batchId}`,
                type: 'GET',
                success: function(row) {
                    populateBatchEditModal(row);
                },
                error: function(xhr) {
                    alert('Error fetching data: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                }
            });
        });

        function populateBatchEditModal(batch) {
            const editModalHtml = `
                <div class="modal fade" id="editBatchModal" tabindex="-1" aria-labelledby="editBatchModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editBatchModalLabel">Edit Batch: ${batch.year} (Sem ${batch.semester})</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="edit-batch-form" action="/edit_row/batches" method="post">
                                    <input type="hidden" name="primary_key" value="batch_id">
                                    <input type="hidden" name="primary_value" value="${batch.batch_id}">
                                    <div class="mb-3">
                                        <label for="edit_batch_year" class="form-label">Batch Year</label>
                                        <input type="number" class="form-control" id="edit_batch_year" name="year" value="${batch.year}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_academic_year" class="form-label">Academic Year</label>
                                        <select class="form-select" id="edit_academic_year" name="academic_year_id" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_batch_semester" class="form-label">Semester</label>
                                        <input type="number" class="form-control" id="edit_batch_semester" name="semester" value="${batch.semester}" min="1" max="8">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>`;

            $('body').append(editModalHtml);
            const editModalEl = document.getElementById('editBatchModal');
            const editModal = new bootstrap.Modal(editModalEl);
            
            $.get('/get_select_options/academic_year_id/academic_years', function(years) {
                const select = $('#edit_academic_year');
                select.empty();
                select.append('<option value="">-- Select Academic Year --</option>');
                years.forEach(year => {
                    const selected = year.id == batch.academic_year_id ? 'selected' : '';
                    select.append(`<option value="${year.id}" ${selected}>${year.name}</option>`);
                });
                editModal.show();
            });

            $('#edit-batch-form').on('submit', function(event) {
                event.preventDefault();
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        alert(response.message);
                        editModal.hide();
                        window.location.reload();
                    },
                    error: function(xhr) {
                        alert('Error updating record: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });
            editModalEl.addEventListener('hidden.bs.modal', function() {
                editModalEl.remove();
            });
        }

        // Edit Modal for Sections
        $(document).on('click', '.edit-btn[data-table="sections"]', function() {
            const sectionId = $(this).data('pk-value');
            $.ajax({
                url: `/get_row/sections?primary_key=section_id&primary_value=${sectionId}`,
                type: 'GET',
                success: function(row) {
                    populateSectionEditModal(row);
                },
                error: function(xhr) {
                    alert('Error fetching data: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                }
            });
        });

        function populateSectionEditModal(section) {
            const editModalHtml = `
                <div class="modal fade" id="editSectionModal" tabindex="-1" aria-labelledby="editSectionModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editSectionModalLabel">Edit Section: ${section.name}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="edit-section-form" action="/edit_row/sections" method="post">
                                    <input type="hidden" name="primary_key" value="section_id">
                                    <input type="hidden" name="primary_value" value="${section.section_id}">
                                    <div class="mb-3">
                                        <label for="edit_section_batch_id" class="form-label">Batch</label>
                                        <select class="form-select" id="edit_section_batch_id" name="batch_id" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_section_name" class="form-label">Section Name</label>
                                        <input type="text" class="form-control" id="edit_section_name" name="name" value="${section.name}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_theory_room_id" class="form-label">Preferred Theory Room</label>
                                        <select class="form-select" id="edit_theory_room_id" name="theory_room_id"></select>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            $('body').append(editModalHtml);
            const editModalEl = document.getElementById('editSectionModal');
            const editModal = new bootstrap.Modal(editModalEl);

            // Fetch and populate batches dropdown
            $.get('/get_select_options/batch_id/batches', function(batches) {
                const select = $('#edit_section_batch_id');
                select.empty();
                select.append('<option value="">-- Select Batch --</option>');
                batches.forEach(batch => {
                    const selected = batch.id == section.batch_id ? 'selected' : '';
                    select.append(`<option value="${batch.id}" ${selected}>${batch.name}</option>`);
                });
            });

            // Fetch and populate rooms dropdown
            $.get('/api/get_rooms_by_type/Lecture', function(rooms) {
                const select = $('#edit_theory_room_id');
                select.empty();
                select.append('<option value="">-- Select Room --</option>');
                rooms.forEach(room => {
                    const selected = room.room_id == section.theory_room_id ? 'selected' : '';
                    select.append(`<option value="${room.room_id}" ${selected}>${room.room_number}</option>`);
                });
                editModal.show();
            });

            $('#edit-section-form').on('submit', function(event) {
                event.preventDefault();
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        alert(response.message);
                        editModal.hide();
                        window.location.reload();
                    },
                    error: function(xhr) {
                        alert('Error updating record: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });
            editModalEl.addEventListener('hidden.bs.modal', function() {
                editModalEl.remove();
            });
        }
    });
</script>
{% endblock %}
