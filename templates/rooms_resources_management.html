{% extends "base1.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Manage Rooms & Resources</h1>
</div>

<div class="form-container mb-4">
    <h4>Add New Room</h4>
    <form action="{{ url_for('add_record', table_name='rooms') }}" method="POST">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="room_number" class="form-label">Room Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="room_number" name="room_number" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="room_type" class="form-label">Room Type <span class="text-danger">*</span></label>
                <select class="form-select" id="room_type" name="room_type" required>
                    <option value="">-- Select Type --</option>
                    <option value="Lecture">Lecture</option>
                    <option value="Lab">Lab</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="capacity" class="form-label">Capacity <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="capacity" name="capacity" min="1" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="building" class="form-label">Building</label>
                <input type="text" class="form-control" id="building" name="building">
            </div>
            <div class="col-md-4 mb-3">
                <label for="floor" class="form-label">Floor</label>
                <input type="number" class="form-control" id="floor" name="floor" min="0">
            </div>
            <div class="col-md-4 mb-3">
                <label for="is_active" class="form-label">Is Active?</label>
                <select class="form-select" id="is_active" name="is_active">
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Room</button>
    </form>
</div>

<div class="form-container mb-4">
    <h4>Add Room Unavailability Slot</h4>
    <form action="{{ url_for('add_record', table_name='room_unavailability') }}" method="POST">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="room_id_unavail" class="form-label">Room <span class="text-danger">*</span></label>
                <select class="form-select" id="room_id_unavail" name="room_id" required>
                    <option value="">-- Select Room --</option>
                    {% for room in rooms %}
                        <option value="{{ room.room_id }}">{{ room.room_number }} ({{ room.room_type }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label for="date_unavail" class="form-label">Date <span class="text-danger">*</span></label>
                <input type="date" class="form-control datepicker" id="date_unavail" name="date" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="start_time_unavail" class="form-label">Start Time <span class="text-danger">*</span></label>
                <input type="time" class="form-control" id="start_time_unavail" name="start_time" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="end_time_unavail" class="form-label">End Time <span class="text-danger">*</span></label>
                <input type="time" class="form-control" id="end_time_unavail" name="end_time" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="reason_unavail" class="form-label">Reason</label>
                <input type="text" class="form-control" id="reason_unavail" name="reason" placeholder="e.g., Maintenance, Event">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Unavailability</button>
    </form>
</div>

<div class="table-container mb-4">
    <h4>Existing Rooms</h4>
    <div class="table-responsive">
        <table id="roomsTable" class="table table-striped table-hover compact">
            <thead>
                <tr>
                    <th>Room ID</th>
                    <th>Number</th>
                    <th>Type</th>
                    <th>Capacity</th>
                    <th>Building</th>
                    <th>Floor</th>
                    <th>Active</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for room in rooms %}
                <tr>
                    <td>{{ room.room_id }}</td>
                    <td>{{ room.room_number }}</td>
                    <td>{{ room.room_type }}</td>
                    <td>{{ room.capacity }}</td>
                    <td>{{ room.building if room.building else 'N/A' }}</td>
                    <td>{{ room.floor if room.floor is not none else 'N/A' }}</td>
                    <td>{{ 'Yes' if room.is_active else 'No' }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn"
                                data-table="rooms"
                                data-pk="room_id"
                                data-pk-value="{{ room.room_id }}">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <a href="{{ url_for('delete_record', table_name='rooms', primary_key='room_id', primary_value=room.room_id) }}"
                           class="btn btn-sm btn-danger delete-btn">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="table-container">
    <h4>Existing Room Unavailability</h4>
    <div class="table-responsive">
        <table id="roomUnavailabilityTable" class="table table-striped table-hover compact">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Room Number</th>
                    <th>Date</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Reason</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for unavail in room_unavailabilities %}
                <tr>
                    <td>{{ unavail.unavailability_id }}</td>
                    <td>{{ unavail.room_number }}</td>
                    <td>{{ unavail.date }}</td>
                    <td>{{ unavail.start_time }}</td>
                    <td>{{ unavail.end_time }}</td>
                    <td>{{ unavail.reason if unavail.reason else 'N/A' }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn"
                                data-table="room_unavailability"
                                data-pk="unavailability_id"
                                data-pk-value="{{ unavail.unavailability_id }}">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <a href="{{ url_for('delete_record', table_name='room_unavailability', primary_key='unavailability_id', primary_value=unavail.unavailability_id) }}"
                           class="btn btn-sm btn-danger delete-btn">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="table-container mt-4">
    <h4>Room Usage Summary</h4>
    <div class="table-responsive">
        <table id="roomUsageSummaryTable" class="table table-striped table-hover compact">
            <thead>
                <tr>
                    <th>Room Number</th>
                    <th>Day</th>
                    <th>Subjects</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<div class="table-container mt-4">
    <h4>Room Timetable & Usage</h4>
    <div class="table-responsive">
        <table id="roomTimetableTable" class="table table-striped table-hover compact">
            <thead>
                <tr>
                    <th>Day</th>
                    <th>Time Slot</th>
                    <th>Room Number</th>
                    <th>Section</th>
                    <th>Subject</th>
                    <th>Faculty</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Initialize DataTables for the first two tables
        $('#roomsTable').DataTable({
            "paging": true, "searching": true, "ordering": true, "info": true, "responsive": true
        });
        $('#roomUnavailabilityTable').DataTable({
            "paging": true, "searching": true, "ordering": true, "info": true, "responsive": true
        });
        
        // Function to load and display room usage summary
        function loadRoomUsageSummary() {
            const tableBody = $('#roomUsageSummaryTable tbody');
            tableBody.empty();
            $.ajax({
                url: '/fetch_room_timetable_data',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if (data.length > 0) {
                        // Group data by room_number and day
                        const groupedData = data.reduce((acc, current) => {
                            const key = `${current.room_number}-${current.day_of_week}`;
                            if (!acc[key]) {
                                acc[key] = {
                                    room_number: current.room_number,
                                    day_of_week: current.day_of_week,
                                    subjects: new Set()
                                };
                            }
                            acc[key].subjects.add(current.subject_name);
                            return acc;
                        }, {});

                        // Convert grouped data to an array and sort it
                        const sortedData = Object.values(groupedData).sort((a, b) => {
                            // Sort by room number first, then by day of the week
                            const daysOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                            if (a.room_number !== b.room_number) {
                                return a.room_number.localeCompare(b.room_number);
                            }
                            return daysOrder.indexOf(a.day_of_week) - daysOrder.indexOf(b.day_of_week);
                        });

                        // Clear the existing DataTable instance if it exists
                        if ($.fn.DataTable.isDataTable('#roomUsageSummaryTable')) {
                            $('#roomUsageSummaryTable').DataTable().destroy();
                        }
                        
                        sortedData.forEach(entry => {
                            const subjectsList = Array.from(entry.subjects).join(', ');
                            const row = `<tr>
                                <td>${entry.room_number}</td>
                                <td>${entry.day_of_week}</td>
                                <td>${subjectsList}</td>
                            </tr>`;
                            tableBody.append(row);
                        });
                    } else {
                        tableBody.append('<tr><td colspan="3" class="text-center">No room usage data found.</td></tr>');
                    }
                    // Re-initialize DataTable after adding new rows
                    $('#roomUsageSummaryTable').DataTable({
                         "paging": true, "searching": true, "ordering": true, "info": true, "responsive": true
                    });
                },
                error: function(xhr) {
                    tableBody.append('<tr><td colspan="3" class="text-center text-danger">Error loading room usage data.</td></tr>');
                    console.error('Error fetching room timetable data:', xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error');
                }
            });
        }

        // Function to load and display room usage timetable with all details
        function loadRoomTimetable() {
            const tableBody = $('#roomTimetableTable tbody');
            tableBody.empty();
            $.ajax({
                url: '/fetch_room_timetable_data',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if ($.fn.DataTable.isDataTable('#roomTimetableTable')) {
                        $('#roomTimetableTable').DataTable().destroy();
                    }
                    if (data.length > 0) {
                        data.forEach(entry => {
                            const row = `<tr>
                                <td>${entry.day_of_week}</td>
                                <td>${entry.start_time} - ${entry.end_time}</td>
                                <td>${entry.room_number}</td>
                                <td>${entry.section_name}</td>
                                <td>${entry.subject_name}</td>
                                <td>${entry.faculty_name}</td>
                            </tr>`;
                            tableBody.append(row);
                        });
                    } else {
                        tableBody.append('<tr><td colspan="6" class="text-center">No timetable entries found for any room.</td></tr>');
                    }
                    // Re-initialize DataTable after adding new rows
                    $('#roomTimetableTable').DataTable({
                         "paging": true, "searching": true, "ordering": true, "info": true, "responsive": true
                    });
                },
                error: function(xhr) {
                    tableBody.append('<tr><td colspan="6" class="text-center text-danger">Error loading timetable data.</td></tr>');
                    console.error('Error fetching room timetable data:', xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error');
                }
            });
        }
        
        loadRoomUsageSummary();
        loadRoomTimetable();

        window.refreshTableData = function() {
            window.location.reload();
        };

        // Generic Edit Modal functionality for this page
        $(document).on('click', '.edit-btn[data-table]', function() {
            const table = $(this).data('table');
            const pk = $(this).data('pk');
            const pkValue = $(this).data('pk-value');

            $.ajax({
                url: `/get_row/${table}?primary_key=${pk}&primary_value=${pkValue}`,
                type: 'GET',
                success: function(row) {
                    if (table === 'rooms') {
                        populateRoomEditModal(row);
                    } else if (table === 'room_unavailability') {
                        populateRoomUnavailabilityEditModal(row);
                    }
                },
                error: function(xhr) {
                    alert('Error fetching data: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                }
            });
        });
        
        // Populates the modal for editing rooms
        function populateRoomEditModal(room) {
            const editModalHtml = `
                <div class="modal fade" id="editRoomModal" tabindex="-1" aria-labelledby="editRoomModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editRoomModalLabel">Edit Room: ${room.room_number}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="edit-room-form" action="/edit_row/rooms" method="post">
                                    <input type="hidden" name="primary_key" value="room_id">
                                    <input type="hidden" name="primary_value" value="${room.room_id}">
                                    <div class="mb-3">
                                        <label for="edit_room_number" class="form-label">Room Number</label>
                                        <input type="text" class="form-control" id="edit_room_number" name="room_number" value="${room.room_number}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_room_type" class="form-label">Room Type</label>
                                        <select class="form-select" id="edit_room_type" name="room_type">
                                            <option value="Lecture" ${room.room_type === 'Lecture' ? 'selected' : ''}>Lecture</option>
                                            <option value="Lab" ${room.room_type === 'Lab' ? 'selected' : ''}>Lab</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_capacity" class="form-label">Capacity</label>
                                        <input type="number" class="form-control" id="edit_capacity" name="capacity" value="${room.capacity}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_building" class="form-label">Building</label>
                                        <input type="text" class="form-control" id="edit_building" name="building" value="${room.building || ''}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_floor" class="form-label">Floor</label>
                                        <input type="number" class="form-control" id="edit_floor" name="floor" value="${room.floor || ''}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_is_active" class="form-label">Is Active?</label>
                                        <select class="form-select" id="edit_is_active" name="is_active">
                                            <option value="1" ${room.is_active === 1 ? 'selected' : ''}>Yes</option>
                                            <option value="0" ${room.is_active === 0 ? 'selected' : ''}>No</option>
                                        </select>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>`;
            $('body').append(editModalHtml);
            const editModalEl = document.getElementById('editRoomModal');
            const editModal = new bootstrap.Modal(editModalEl);
            editModal.show();
            editModalEl.addEventListener('hidden.bs.modal', function() {
                editModalEl.remove();
            });
        }

        // Populates the modal for editing room unavailability
        function populateRoomUnavailabilityEditModal(unavail) {
            const editModalHtml = `
                <div class="modal fade" id="editRoomUnavailModal" tabindex="-1" aria-labelledby="editRoomUnavailModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editRoomUnavailModalLabel">Edit Unavailability: ${unavail.room_number}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="edit-room-unavail-form" action="/edit_row/room_unavailability" method="post">
                                    <input type="hidden" name="primary_key" value="unavailability_id">
                                    <input type="hidden" name="primary_value" value="${unavail.unavailability_id}">
                                    <div class="mb-3">
                                        <label for="edit_room_id" class="form-label">Room</label>
                                        <select class="form-select" id="edit_room_id" name="room_id"></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_date" class="form-label">Date</label>
                                        <input type="date" class="form-control" id="edit_date" name="date" value="${unavail.date}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_start_time" class="form-label">Start Time</label>
                                        <input type="time" class="form-control" id="edit_start_time" name="start_time" value="${unavail.start_time}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_end_time" class="form-label">End Time</label>
                                        <input type="time" class="form-control" id="edit_end_time" name="end_time" value="${unavail.end_time}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="edit_reason" class="form-label">Reason</label>
                                        <input type="text" class="form-control" id="edit_reason" name="reason" value="${unavail.reason || ''}">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>`;
            $('body').append(editModalHtml);
            const editModalEl = document.getElementById('editRoomUnavailModal');
            const editModal = new bootstrap.Modal(editModalEl);
            
            // Populate rooms dropdown
            $.get('/get_select_options/room_id/rooms', function(rooms) {
                const select = $('#edit_room_id');
                select.empty();
                select.append('<option value="">-- Select Room --</option>');
                rooms.forEach(room => {
                    const selected = room.id == unavail.room_id ? 'selected' : '';
                    select.append(`<option value="${room.id}" ${selected}>${room.name}</option>`);
                });
                editModal.show();
            });

            $('#edit-room-unavail-form').on('submit', function(event) {
                event.preventDefault();
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        alert(response.message);
                        editModal.hide();
                        window.location.reload();
                    },
                    error: function(xhr) {
                        alert('Error updating record: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });
            editModalEl.addEventListener('hidden.bs.modal', function() {
                editModalEl.remove();
            });
        }
    });
</script>
{% endblock %}
