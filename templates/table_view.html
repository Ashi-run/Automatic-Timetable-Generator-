{% extends "base1.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Viewing Table: {{ table_name }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('tables') }}" class="btn btn-sm btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to All Tables
        </a>
    </div>
</div>

<div class="form-container mb-4">
    <h4>Add New Record to {{ table_name }}</h4>
    <form id="addForm" method="POST" action="{{ url_for('add_record', table_name=table_name) }}">
        <div class="row">
            {% for column in columns %}
                {# Exclude auto-incrementing primary keys from the add form #}
                {% if column not in primary_keys or table_name == 'user_roles' %} {# user_roles has composite PK, allow input #}
                <div class="col-md-4 mb-3">
                    <label for="add_{{ column }}" class="form-label">{{ column | replace('_', ' ') | capitalize }}</label>
                    {% if column in referenced_tables %}
                        <select class="form-select" id="add_{{ column }}" name="{{ column }}">
                            <option value="">-- Select {{ referenced_tables[column]['table'] | replace('_', ' ') }} --</option>
                            {% for value in referenced_tables[column]['values'] %}
                                <option value="{{ value.id if value.id is defined else value }}">{{ value.name if value.name is defined else value }}</option>
                            {% endfor %}
                        </select>
                    {% elif 'date' in column %}
                        <input type="date" class="form-control datepicker" id="add_{{ column }}" name="{{ column }}">
                    {% elif 'time' in column and not 'timestamp' in column %}
                        <input type="time" class="form-control" id="add_{{ column }}" name="{{ column }}">
                    {% elif column in ['is_active', 'has_lab', 'term_end_exam', 'is_internal_only', 'is_current', 'affects_timetable', 'is_rescheduled', 'is_lab_session', 'seen'] %}
                        <select class="form-select" id="add_{{ column }}" name="{{ column }}">
                            <option value="1">Yes</option>
                            <option value="0" selected>No</option>
                        </select>
                    {% elif column == 'available_days' %}
                        {# This will be a text input for simple comma-separated string #}
                        <input type="text" class="form-control" id="add_{{ column }}" name="{{ column }}" placeholder="e.g., Mon,Tue,Wed">
                        <small class="text-muted">Comma-separated days (e.g., Mon, Tue, Fri)</small>
                    {% elif column == 'room_type' %}
                         <select class="form-select" id="add_{{ column }}" name="{{ column }}">
                            <option value="Lecture">Lecture</option>
                            <option value="Lab">Lab</option>
                        </select>
                    {% elif column == 'holiday_type' %}
                        <select class="form-select" id="add_{{ column }}" name="{{ column }}">
                            <option value="University">University</option>
                            <option value="National">National</option>
                            <option value="Exam">Exam</option>
                            <option value="Break">Break</option>
                        </select>
                    {% elif column == 'status' and table_name == 'timetable_generation_log' %}
                         <select class="form-select" id="add_{{ column }}" name="{{ column }}">
                            <option value="Success">Success</option>
                            <option value="Failed">Failed</option>
                            <option value="Partial">Partial</option>
                        </select>
                    {% elif column == 'employment_type' %}
                        <select class="form-select" id="add_{{ column }}" name="{{ column }}">
                            <option value="permanent">Permanent</option>
                            <option value="visiting">Visiting</option>
                        </select>
                    {% else %}
                        <input type="text" class="form-control" id="add_{{ column }}" name="{{ column }}">
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        </div>
        <button type="submit" class="btn btn-primary mt-3">Add Record</button>
    </form>
</div>

<div class="table-container">
    <div class="table-responsive">
        <table id="dataTable" class="table table-striped table-hover compact">
            <thead>
                <tr>
                    {% for column in columns %}
                    <th>{{ column | replace('_', ' ') | capitalize }}</th>
                    {% endfor %}
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr>
                    {% for column in columns %}
                    <td>
                        {% if row[column] is none %}
                            <span class="text-muted">NULL</span>
                        {% elif column == 'available_days' and row[column] %}
                            {# Display JSON array nicely #}
                            {{ row[column]|from_json|join(', ') if row[column] is not none else row[column] }}
                        {% elif 'date' in column or 'time' in column %}
                            {{ row[column] }} {# Flask will convert datetime objects to strings #}
                        {% elif column in ['is_active', 'has_lab', 'term_end_exam', 'is_internal_only', 'is_current', 'affects_timetable', 'is_rescheduled', 'is_lab_session', 'seen'] %}
                            {{ 'Yes' if row[column] == 1 else 'No' }}
                        {% elif row[column]|string|length > 50 %} {# Truncate long text for readability #}
                            <span title="{{ row[column] }}">{{ row[column][:50] }}...</span>
                        {% else %}
                            {{ row[column] }}
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td>
                        {% if primary_keys %}
                            <button class="btn btn-sm btn-warning edit-btn"
                                    data-table="{{ table_name }}"
                                    data-pk="{{ primary_keys[0] }}"
                                    data-pk-value="{{ row[primary_keys[0]]|string }}">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <a href="{{ url_for('delete_record', table_name=table_name, primary_key=primary_keys[0], primary_value=row[primary_keys[0]]) }}"
                               class="btn btn-sm btn-danger"
                               onclick="return confirm('Are you sure you want to delete this record? This action cannot be undone and may affect related data due to foreign key constraints.')">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        {% else %}
                            <span class="text-muted">No PK for actions</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Initialize DataTables
        $('#dataTable').DataTable({
            "paging": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "responsive": true // Make table responsive on smaller screens
        });

        // Initialize datepickers for the add form
        $('#addForm .datepicker').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true
        });

        // Initialize dependent dropdowns on page load for add form where applicable
        // This is a more generalized approach. For specific management pages,
        // you'd have dedicated scripts for specific dependencies.

        // Example: If 'departments' table, and 'school_id' is a column with referenced_tables
        // You might need to trigger this for specific dropdowns.
        // For 'table_view', it uses the generic `referenced_tables` which are already populated.
    });
</script>
{% endblock %}
