<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMIMS MPSTME - Timetable Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            color: #424242; /* Darker gray for better readability */
            margin-top: 56px; /* Offset for fixed navbar */
            padding: 0;
        }
        .navbar {
            background-color: #D32F2F; /* NMIMS Red */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand, .navbar-nav .nav-link {
            color: #FFFFFF !important;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .navbar-nav .nav-link:hover, .navbar-nav .nav-link.active {
            color: #FFCDD2 !important; /* Lighter red for hover/active */
        }
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .content {
            padding: 20px;
            min-height: calc(100vh - 56px); /* Adjust for navbar height */
        }
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .card:hover {
            transform: translateY(-3px); /* Slightly less dramatic hover */
        }
        .card-header {
            background-color: #D32F2F;
            color: #FFFFFF;
            border-radius: 8px 8px 0 0;
            padding: 15px;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #D32F2F;
            border-color: #D32F2F;
            padding: 8px 20px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background-color: #B71C1C; /* Darker red */
            border-color: #B71C1C;
        }
        .btn-secondary {
            background-color: #757575;
            border-color: #757575;
            color: #FFFFFF;
        }
        .btn-secondary:hover {
            background-color: #616161; /* Darker gray */
            border-color: #616161;
        }
        .btn-warning {
            background-color: #ff9800;
            border-color: #ff9800;
            color: #FFFFFF;
        }
        .btn-warning:hover {
            background-color: #e68900;
            border-color: #e68900;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: #FFFFFF;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .table-container, .form-container {
            background-color: #FFFFFF;
            padding: 20px; /* Increased padding */
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .alert {
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .modal-content {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3, h4, h5 {
            color: #D32F2F;
            margin-bottom: 15px;
        }
        .text-muted {
            color: #B0BEC5 !important;
        }
        table.dataTable thead th {
            background-color: #D32F2F;
            color: white;
        }
        table.dataTable {
            width: 100% !important;
        }
        table.dataTable tbody tr:hover {
            background-color: #f5f5f5;
        }
        /* Custom Message Modal Styles */
        #messageModal .modal-header {
            background-color: #D32F2F;
            color: white;
        }
        #messageModal.alert-success .modal-header { background-color: #28a745; }
        #messageModal.alert-danger .modal-header { background-color: #dc3545; }
        #messageModal.alert-warning .modal-header { background-color: #ffc107; }
        #messageModal.alert-info .modal-header { background-color: #17a2b8; }
        
        /* Timetable Grid Styles */
        .timetable-grid {
            width: 100%;
            border-collapse: collapse;
        }
        .timetable-grid th,
        .timetable-grid td {
            border: 1px solid #dee2e6;
            padding: 10px;
            vertical-align: top;
        }
        .timetable-grid th {
            background-color: #D32F2F;
            color: white;
            text-align: center;
        }
        .timetable-entry {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        .timetable-entry:last-child {
            margin-bottom: 0;
        }
        .timetable-entry .badge {
            font-size: 0.7rem;
        }

        /* Custom Confirmation Modal Styles */
        #confirmationModal .modal-header {
            background-color: #ffc107; /* Warning yellow by default */
            color: white;
        }
        #confirmationModal .btn-confirm-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        #confirmationModal .btn-confirm-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        /* Loading spinner styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1060; /* Higher than Bootstrap modals (1050) */
            flex-direction: column;
            gap: 15px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #D32F2F;
        }
        .loading-text {
            color: #D32F2F;
            font-size: 1.2rem;
            font-weight: bold;
        }


        @media (max-width: 768px) {
            .content {
                padding: 10px;
            }
            .card-header {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index1') }}">
                <img src="{{ url_for('static', filename='NMIMS-logo.jpg') }}" height="30" class="me-2" alt="NMIMS Logo">
                NMIMS MPSTME
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'index1' %}active{% endif %}" href="{{ url_for('index1') }}">Dashboard</a>
                    </li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarTimetableDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Timetable
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarTimetableDropdown">
                            <li><a class="dropdown-item {% if request.endpoint == 'timetable_viewer' %}active{% endif %}" href="{{ url_for('timetable_viewer') }}">View Timetable</a></li>
                            {# Add a link for timetable generation if it gets its own page #}
                            {# <li><a class="dropdown-item" href="{{ url_for('timetable_generation_page') }}">Generate Timetable</a></li> #}
                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDataDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Data Management
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDataDropdown">
                            <li><a class="dropdown-item {% if request.endpoint == 'subjects_management' %}active{% endif %}" href="{{ url_for('subjects_management') }}">Subjects</a></li>
                            <li><a class="dropdown-item {% if request.endpoint == 'batches_sections_management' %}active{% endif %}" href="{{ url_for('batches_sections_management') }}">Batches & Sections</a></li>
                            <li><a class="dropdown-item {% if request.endpoint == 'batch_subject_mapping_management' %}active{% endif %}" href="{{ url_for('batch_subject_mapping_management') }}">Batch-Subject Mapping</a></li>
                            <li><a class="dropdown-item {% if request.endpoint == 'faculty_assignments' %}active{% endif %}" href="{{ url_for('faculty_assignments') }}">Faculty Assignments</a></li>
                            <li><a class="dropdown-item {% if request.endpoint == 'faculty_constraints_management' %}active{% endif %}" href="{{ url_for('faculty_constraints_management') }}">Faculty Constraints</a></li>
                            <li><a class="dropdown-item {% if request.endpoint == 'faculty_unavailability_management' %}active{% endif %}" href="{{ url_for('faculty_unavailability_management') }}">Faculty Unavailability</a></li>
                            <li><a class="dropdown-item {% if request.endpoint == 'rooms_resources_management' %}active{% endif %}" href="{{ url_for('rooms_resources_management') }}">Rooms & Resources</a></li>
                            <li><a class="dropdown-item {% if request.endpoint == 'holidays_management' %}active{% endif %}" href="{{ url_for('holidays_management') }}">Holidays</a></li>
                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarAdminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Admin
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarAdminDropdown">
                            <li><a class="dropdown-item {% if request.endpoint == 'departments_schools_management' %}active{% endif %}" href="{{ url_for('departments_schools_management') }}">Depts & Schools</a></li>
                            <li><a class="dropdown-item {% if request.endpoint == 'tables' %}active{% endif %}" href="{{ url_for('tables') }}">Raw Tables</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container content">
        {# Custom Message Modal Placeholder #}
        <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="messageModalLabel">Message</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="messageModalBody">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        {# Custom Confirmation Modal Placeholder #}
        <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-white">
                        <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="confirmationModalBody">
                        Are you sure you want to perform this action?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-confirm-danger" id="confirmActionBtn">Confirm</button>
                    </div>
                </div>
            </div>
        </div>


        {# Flash messages from Flask #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'warning' if category == 'warning' else 'info' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="editModalBody">
                </div>
            </div>
        </div>
    </div>

    {# Global Loading Overlay #}
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="loading-text">Loading... Please wait.</div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    {% block scripts %}{% endblock %}
    <script>
        $(document).ready(function() {
            // Global function to show custom message modal
            window.showMessageModal = function(message, type = 'info') {
                const modal = $('#messageModal');
                const modalHeader = modal.find('.modal-header');
                const modalTitle = modal.find('.modal-title');
                const modalBody = $('#messageModalBody');

                // Reset classes
                modalHeader.removeClass('bg-success bg-danger bg-warning bg-info');

                // Set content and class based on type
                modalBody.html(message);
                if (type === 'success') {
                    modalHeader.addClass('bg-success');
                    modalTitle.text('Success');
                } else if (type === 'error') {
                    modalHeader.addClass('bg-danger');
                    modalTitle.text('Error');
                } else if (type === 'warning') {
                    modalHeader.addClass('bg-warning');
                    modalTitle.text('Warning');
                } else { // info
                    modalHeader.addClass('bg-info');
                    modalTitle.text('Information');
                }
                modal.modal('show');
            };

            // Global function to show custom confirmation modal
            window.showConfirmationModal = function(message, onConfirmCallback) {
                const modal = $('#confirmationModal');
                const modalBody = $('#confirmationModalBody');
                const confirmButton = $('#confirmActionBtn');

                modalBody.html(message);

                // Remove any previous click handlers to prevent multiple executions
                confirmButton.off('click'); 
                confirmButton.on('click', function() {
                    modal.modal('hide');
                    if (onConfirmCallback && typeof onConfirmCallback === 'function') {
                        onConfirmCallback();
                    }
                });

                modal.modal('show');
            };

            // Global function to show/hide loading overlay
            window.showLoading = function(show) {
                if (show) {
                    $('#loadingOverlay').removeClass('d-none');
                } else {
                    $('#loadingOverlay').addClass('d-none');
                }
            };


            // Initialize datepickers
            $('.datepicker').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true
            });

            // Generic AJAX for Edit Modal (used by table_view.html and potentially others)
            $(document).on('click', '.edit-btn', function() {
                const tableName = $(this).data('table');
                const pk = $(this).data('pk');
                const pkValue = $(this).data('pk-value');
                
                window.showLoading(true); // Show loading
                $.get(`/get_row/${tableName}?primary_key=${pk}&primary_value=${pkValue}`, function(data) {
                    window.showLoading(false); // Hide loading
                    if (data.error) {
                        window.showMessageModal('Error fetching row data: ' + data.error, 'error');
                        return;
                    }
                    
                    let formHtml = `
                        <form id="editForm" method="POST" action="/edit_row/${tableName}">
                            <input type="hidden" name="primary_key" value="${pk}">
                            <input type="hidden" name="primary_value" value="${pkValue}">
                            <div class="row">
                    `;
                    
                    const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

                    // Clear previous content before appending new form fields
                    $('#editModalBody').empty(); 

                    for (let column in data) {
                        if (column !== pk) {
                            let value = data[column] !== null ? data[column] : '';
                            formHtml += `<div class="col-md-6 mb-3"><label for="edit_${column}" class="form-label">${column.replace(/_/g, ' ')}</label>`;

                            // Logic for foreign key dropdowns
                            if (column.includes('_id')) {
                                let refTableName = '';
                                
                                // Specific mappings for known foreign keys (as defined in app.py's get_select_options)
                                if (column === 'faculty_id' || column === 'canceled_by' || column === 'suggested_faculty_id' || column === 'requested_to' || column === 'user_id') {
                                    refTableName = 'users';
                                } else if (column === 'batch_id') {
                                    refTableName = 'batches';
                                } else if (column === 'academic_year_id') {
                                    refTableName = 'academic_years';
                                } else if (column === 'subject_id') {
                                    refTableName = 'subjects';
                                } else if (column === 'section_id') {
                                    refTableName = 'sections';
                                } else if (column === 'subsection_id') {
                                    refTableName = 'subsections';
                                } else if (column === 'room_id') {
                                    refTableName = 'rooms';
                                } else if (column === 'school_id') {
                                    refTableName = 'schools';
                                } else if (column === 'department_id') {
                                    refTableName = 'departments';
                                } else if (column === 'batch_subject_id') {
                                    refTableName = 'batch_subjects';
                                } else if (column === 'timeslot_id') {
                                    refTableName = 'timeslots';
                                } else {
                                    // Fallback: Guess table name by removing _id and pluralizing
                                    refTableName = column.replace('_id', '');
                                    if (refTableName.endsWith('y')) { // e.g., faculty -> faculties
                                        refTableName = refTableName.slice(0, -1) + 'ies';
                                    } else {
                                        refTableName += 's';
                                    }
                                }
                                
                                formHtml += `<select class="form-select fk-dropdown" id="edit_${column}" name="${column}" data-ref-table="${refTableName}"><option value="">Loading...</option></select>`;
                                // Immediately load options for this FK dropdown
                                (function(col, val, rTable) {
                                    $.getJSON(`/get_select_options/${col}/${rTable}`, function(options) {
                                        let selectHtml = `<option value="">-- Select ${rTable.replace(/_/g, ' ')} --</option>`;
                                        options.forEach(function(option) {
                                            // options can be {id: ..., name: ...} or just primitive values
                                            const optionValue = option.id !== undefined ? option.id : option;
                                            const optionText = option.name !== undefined ? option.name : option;
                                            const selected = (String(optionValue) === String(val)) ? 'selected' : ''; // Compare as strings for consistency
                                            selectHtml += `<option value="${optionValue}" ${selected}>${optionText}</option>`;
                                        });
                                        $(`#edit_${col}`).html(selectHtml);
                                    }).fail(function(jqXHR) {
                                        $(`#edit_${col}`).html('<option value="">Error loading options</option>');
                                        console.error(`Error loading options for ${rTable}.${col}:`, jqXHR.responseJSON?.error || jqXHR.responseText);
                                        window.showMessageModal(`Error loading options for ${rTable.replace(/_/g, ' ')} dropdown: ` + (jqXHR.responseJSON?.error || jqXHR.responseText), 'error');
                                    });
                                })(column, value, refTableName);

                            } else if (column.includes('date')) {
                                formHtml += `<input type="date" class="form-control datepicker" id="edit_${column}" name="${column}" value="${value}">`;
                            } else if (column.includes('time')) {
                                formHtml += `<input type="time" class="form-control" id="edit_${column}" name="${column}" value="${value}">`;
                            } else if (['is_active', 'has_lab', 'term_end_exam', 'is_internal_only', 'is_current', 'affects_timetable', 'is_rescheduled', 'is_lab_session', 'seen', 'is_visiting_faculty'].includes(column)) {
                                formHtml += `
                                    <select class="form-select" id="edit_${column}" name="${column}">
                                        <option value="1" ${value == 1 ? 'selected' : ''}>Yes</option>
                                        <option value="0" ${value == 0 ? 'selected' : ''}>No</option>
                                    </select>
                                `;
                            } else if (column === 'available_days') {
                                // value here is already a parsed array from get_row
                                let currentDays = Array.isArray(value) ? value : [];
                                formHtml += `<div>`;
                                daysOfWeek.forEach(function(day) {
                                    const checked = currentDays.includes(day) ? 'checked' : '';
                                    formHtml += `
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="edit_${column}_${day}" name="${column}" value="${day}" ${checked}>
                                            <label class="form-check-label" for="edit_${column}_${day}">${day}</label>
                                        </div>
                                    `;
                                });
                                formHtml += `</div>`;
                            }
                            else if (column === 'room_type') {
                                formHtml += `
                                    <select class="form-select" id="edit_${column}" name="${column}">
                                        <option value="Lecture" ${value === 'Lecture' ? 'selected' : ''}>Lecture</option>
                                        <option value="Lab" ${value === 'Lab' ? 'selected' : ''}>Lab</option>
                                    </select>
                                `;
                            }
                            else if (column === 'type' && tableName === 'notifications') {
                                formHtml += `<input type="text" class="form-control" id="edit_${column}" name="${column}" value="${value}" placeholder="e.g., alert, info, warning">`;
                            }
                            else if (column === 'holiday_type' && tableName === 'holidays') {
                                formHtml += `
                                    <select class="form-select" id="edit_${column}" name="${column}">
                                        <option value="University" ${value === 'University' ? 'selected' : ''}>University</option>
                                        <option value="National" ${value === 'National' ? 'selected' : ''}>National</option>
                                        <option value="Exam" ${value === 'Exam' ? 'selected' : ''}>Exam</option>
                                        <option value="Break" ${value === 'Break' ? 'selected' : ''}>Break</option>
                                    </select>
                                `;
                            }
                            else if (column === 'status' && tableName === 'timetable_generation_log') {
                                formHtml += `
                                    <select class="form-select" id="edit_${column}" name="${column}">
                                        <option value="Success" ${value === 'Success' ? 'selected' : ''}>Success</option>
                                        <option value="Failed" ${value === 'Failed' ? 'selected' : ''}>Failed</option>
                                        <option value="Partial" ${value === 'Partial' ? 'selected' : ''}>Partial</option>
                                    </select>
                                `;
                            }
                            else if (column === 'role' && tableName === 'users') {
                                formHtml += `<input type="text" class="form-control" id="edit_${column}" name="${column}" value="${value}" placeholder="e.g., faculty, student, admin, coordinator">`;
                            }
                            else if (column === 'employment_type' && tableName === 'users') {
                                formHtml += `
                                    <select class="form-select" id="edit_${column}" name="${column}">
                                        <option value="permanent" ${value === 'permanent' ? 'selected' : ''}>Permanent</option>
                                        <option value="visiting" ${value === 'visiting' ? 'selected' : ''}>Visiting</option>
                                    </select>
                                `;
                            }
                            else if (typeof value === 'object' && value !== null) { // For JSON columns like constraints_violated
                                formHtml += `<textarea class="form-control" id="edit_${column}" name="${column}" rows="3">${JSON.stringify(value, null, 2)}</textarea>`;
                            }
                            else {
                                formHtml += `<input type="text" class="form-control" id="edit_${column}" name="${column}" value="${value}">`;
                            }
                            formHtml += `</div>`;
                        }
                    }
                    
                    formHtml += `
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    `;
                    
                    $('#editModalBody').html(formHtml);
                    $('#editModal').modal('show');

                    // Re-initialize datepickers for the new form content
                    $('#editModal .datepicker').datepicker({
                        format: 'yyyy-mm-dd',
                        autoclose: true,
                        todayHighlight: true
                    });
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    window.showLoading(false); // Hide loading
                    window.showMessageModal('Failed to fetch row data: ' + (jqXHR.responseJSON?.error || jqXHR.responseText), 'error');
                });
            });

            // Handle form submission within modal (using event delegation for dynamically loaded forms)
            $(document).off('submit', '#editForm').on('submit', '#editForm', function(e) {
                e.preventDefault();
                const formData = $(this).serializeArray();
                const formAction = $(this).attr('action');

                // Special handling for `available_days` if it's a checkbox group
                const availableDaysValues = [];
                // Collect only checked values for available_days
                $(this).find('input[name="available_days"]:checked').each(function() {
                    availableDaysValues.push($(this).val());
                });
                
                // Remove existing 'available_days' entries from formData to avoid duplicates
                let finalFormData = formData.filter(item => item.name !== 'available_days');
                
                // Add the consolidated 'available_days' as a single entry (JSON string)
                if (availableDaysValues.length > 0) {
                    finalFormData.push({name: 'available_days', value: availableDaysValues.join(',')}); // Send as comma-separated string
                } else {
                    finalFormData.push({name: 'available_days', value: ''}); // Send empty string if none are selected
                }
                
                window.showLoading(true); // Show loading
                $.post(formAction, $.param(finalFormData), function(response) {
                    window.showLoading(false); // Hide loading
                    $('#editModal').modal('hide');
                    window.showMessageModal(response.message || 'Changes saved successfully!', 'success');
                    // Reload the page only if current page relies on full refresh (e.g., non-AJAX tables)
                    // For fully AJAX tables, a call to refresh the data table is preferred.
                    if (typeof window.refreshTableData === 'function') { // Check if page has specific refresh function
                        window.refreshTableData();
                    } else {
                        window.location.reload(); // Fallback to full page reload
                    }
                }).fail(function(jqXHR) {
                    window.showLoading(false); // Hide loading
                    window.showMessageModal('Error saving changes: ' + (jqXHR.responseJSON?.error || jqXHR.responseText), 'error');
                });
            });

            // Generic AJAX for Delete Buttons
            $(document).on('click', '.delete-btn', function(e) {
                e.preventDefault(); // Prevent default link behavior
                const deleteUrl = $(this).attr('href');
                
                window.showConfirmationModal('Are you sure you want to delete this record? This action cannot be undone.', function() {
                    window.showLoading(true); // Show loading
                    $.ajax({
                        url: deleteUrl,
                        type: 'GET', // Or 'DELETE' if your Flask route supports it
                        headers: {'X-Requested-With': 'XMLHttpRequest'}, // Indicate AJAX request
                        success: function(response) {
                            window.showLoading(false); // Hide loading
                            window.showMessageModal(response.message || 'Record deleted successfully!', 'success');
                            if (typeof window.refreshTableData === 'function') {
                                window.refreshTableData();
                            } else {
                                window.location.reload();
                            }
                        },
                        error: function(jqXHR) {
                            window.showLoading(false); // Hide loading
                            window.showMessageModal('Error deleting record: ' + (jqXHR.responseJSON?.error || jqXHR.responseText), 'error');
                        }
                    });
                });
            });

            // Prevent submission of forms outside modals if they trigger native confirm/alert
            // This is a safety net; ideally, all form submissions should use custom modals.
            $('form').each(function() {
                if ($(this).find('[onclick*="confirm("]').length > 0) {
                    $(this).find('[onclick*="confirm("]').each(function() {
                        $(this).removeAttr('onclick').on('click', function(e) {
                            e.preventDefault();
                            const form = $(this).closest('form');
                            window.showConfirmationModal('Are you sure you want to submit this form?', function() {
                                form.submit();
                            });
                        });
                    });
                }
            });
        });
    </script>
</body>
</html>
