{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Manage Faculty Constraints</h1>
</div>

<div class="form-container mb-4">
    <h4>Add/Edit Faculty Constraint</h4>
    <form action="{{ url_for('add_record', table_name='faculty_constraints') }}" method="POST">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="faculty_id_constraint" class="form-label">Faculty <span class="text-danger">*</span></label>
                <select class="form-select" id="faculty_id_constraint" name="faculty_id" required>
                    <option value="">-- Select Faculty --</option>
                    {% for faculty in faculties %}
                        <option value="{{ faculty.user_id }}">{{ faculty.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label for="max_hours_per_week" class="form-label">Max Hours Per Week: <span id="max_hours_per_week_val">16</span></label>
                <input type="range" class="form-range" id="max_hours_per_week" name="max_hours_per_week" min="0" max="40" value="16">
            </div>
            <div class="col-md-6 mb-3">
                <label for="max_hours_per_day" class="form-label">Max Hours Per Day: <span id="max_hours_per_day_val">3</span></label>
                <input type="range" class="form-range" id="max_hours_per_day" name="max_hours_per_day" min="0" max="8" value="3">
            </div>
            <div class="col-md-6 mb-3">
                <label for="is_visiting_faculty" class="form-label">Is Visiting Faculty?</label>
                <select class="form-select" id="is_visiting_faculty" name="is_visiting_faculty">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            <div class="col-md-12 mb-3">
                <label class="form-label">Available Days:</label><br>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="mon" name="available_days" value="Mon">
                    <label class="form-check-label" for="mon">Monday</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tue" name="available_days" value="Tue">
                    <label class="form-check-label" for="tue">Tuesday</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="wed" name="available_days" value="Wed">
                    <label class="form-check-label" for="wed">Wednesday</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="thu" name="available_days" value="Thu">
                    <label class="form-check-label" for="thu">Thursday</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="fri" name="available_days" value="Fri">
                    <label class="form-check-label" for="fri">Friday</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="sat" name="available_days" value="Sat">
                    <label class="form-check-label" for="sat">Saturday</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="sun" name="available_days" value="Sun">
                    <label class="form-check-label" for="sun">Sunday</label>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="min_weekly_hours" class="form-label">Min Weekly Hours (Optional)</label>
                <input type="number" class="form-control" id="min_weekly_hours" name="min_weekly_hours" min="0">
            </div>
            <div class="col-md-6 mb-3">
                <label for="max_weekly_hours" class="form-label">Max Weekly Hours (Optional)</label>
                <input type="number" class="form-control" id="max_weekly_hours" name="max_weekly_hours" min="0">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Save Constraint</button>
    </form>
</div>

<div class="table-container">
    <h4>Existing Faculty Constraints</h4>
    <div class="table-responsive">
        <table id="constraintsTable" class="table table-striped table-hover compact">
            <thead>
                <tr>
                    <th>Constraint ID</th>
                    <th>Faculty Name</th>
                    <th>Max Hours/Week</th>
                    <th>Max Hours/Day</th>
                    <th>Visiting Faculty</th>
                    <th>Available Days</th>
                    <th>Min Weekly</th>
                    <th>Max Weekly</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for constraint in constraints %}
                <tr>
                    <td>{{ constraint.constraint_id }}</td>
                    <td>{{ constraint.faculty_name }}</td>
                    <td>{{ constraint.max_hours_per_week }}</td>
                    <td>{{ constraint.max_hours_per_day }}</td>
                    <td>{{ 'Yes' if constraint.is_visiting_faculty else 'No' }}</td>
                    <td>
                        {% if constraint.available_days %}
                            {{ constraint.available_days|join(', ') }}
                        {% else %}
                            <span class="text-muted">Not Set</span>
                        {% endif %}
                    </td>
                    <td>{{ constraint.min_weekly_hours if constraint.min_weekly_hours is not none else 'N/A' }}</td>
                    <td>{{ constraint.max_weekly_hours if constraint.max_weekly_hours is not none else 'N/A' }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn"
                                data-table="faculty_constraints"
                                data-pk="constraint_id"
                                data-pk-value="{{ constraint.constraint_id }}">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <a href="{{ url_for('delete_record', table_name='faculty_constraints', primary_key='constraint_id', primary_value=constraint.constraint_id) }}"
                           class="btn btn-sm btn-danger delete-btn">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('#constraintsTable').DataTable({
            "paging": true, "searching": true, "ordering": true, "info": true, "responsive": true
        });

        // Update slider value displays
        $('#max_hours_per_week').on('input', function() {
            $('#max_hours_per_week_val').text($(this).val());
        });
        $('#max_hours_per_day').on('input', function() {
            $('#max_hours_per_day_val').text($(this).val());
        });

        // When the modal opens for editing, specifically handle available_days checkboxes
        $('#editModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget); // Button that triggered the modal
            const pkValue = button.data('pk-value');
            const tableName = button.data('table');
            const pk = button.data('pk');

            // Fetch the row data again to populate the form correctly
            window.showLoading(true); // Show loading inside modal
            $.get(`/get_row/${tableName}?primary_key=${pk}&primary_value=${pkValue}`, function(data) {
                window.showLoading(false); // Hide loading
                if (data.error) {
                    window.showMessageModal('Error fetching row data: ' + data.error, 'error');
                    return;
                }
                
                // If 'available_days' exists and is an array (after parsing in Flask), use it
                let availableDaysArray = Array.isArray(data.available_days) ? data.available_days : [];
                
                // Uncheck all checkboxes first (important for subsequent edits)
                $('#editModalBody input[name="available_days"]').prop('checked', false);

                // Check checkboxes based on the fetched data
                availableDaysArray.forEach(function(day) {
                    $('#editModalBody input[name="available_days"][value="' + day + '"]').prop('checked', true);
                });

                // Update slider values
                $('#editModalBody #max_hours_per_week_val').text(data.max_hours_per_week || '0');
                $('#editModalBody #max_hours_per_day_val').text(data.max_hours_per_day || '0');

            }).fail(function(jqXHR) {
                window.showLoading(false); // Hide loading
                window.showMessageModal('Error fetching constraint data for edit: ' + (jqXHR.responseJSON?.error || jqXHR.responseText), 'error');
            });
        });

        // Override generic refreshTableData for this page to just reload
        // This is necessary because we are not using AJAX to refresh the table here.
        window.refreshTableData = function() {
            window.location.reload();
        };

        // Removed the duplicate custom submit handler for #editForm
        // The generic handler in base.html now correctly handles available_days.
    });
</script>
{% endblock %}
